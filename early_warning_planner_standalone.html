<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Early warning and Emergency planner</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
    sans-serif;
}

html, body {
  background-color: #ffffff;
  color: #222222;
  height: 100%;
  margin: 0;
  padding: 0;
}

.app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.top-bar {
  padding: 0.75rem 1.25rem;
  border-bottom: 1px solid #e1e1e1;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.title {
  font-size: 1.5rem;
  font-weight: 600;
}

.tabs {
  margin-top: 1.5rem;
  display: flex;
  gap: 0.7rem;
  padding: 0.5rem 1.25rem 0;
  border-bottom: 1px solid #e1e1e1;
  background: #fafafa;
}

.tab-button {
  padding: 0.45rem 1.15rem;
  border-radius: 12px 12px 0 0;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  background: #f5f5f5;
  cursor: pointer;
  font-size: 1.15rem;
  color: red !important;
  transition: background 0.15s, color 0.15s, box-shadow 0.15s;
}

.tab-button.active {
  background: #ffffff;
  color: #222222;
  box-shadow: 0 -1px 0 #ffffff, 0 0 0 1px rgba(0, 0, 0, 0.03);
}

.tab-button:hover {
  color: #b30000 !important;
}

.tab-button:hover:not(.active) {
  background: #ebebeb;
}

.tab-content {
  display: none;
  padding: 1rem 1.25rem 1.5rem;
}

.tab-content.active {
  display: block;
}

.layout {
  display: flex;
  gap: 1rem;
  flex: 1 1 auto;
  /* give more vertical room */
  min-height: 600px;
  align-items: stretch;
}

.map-container {
  flex: 3;
  min-width: 0;
  border-radius: 12px;
  border: 1px solid #e0e0e0;
  overflow: hidden;
  background: #f2f2f2;
}

/* The map fills the container vertically */
#map-ch,
#map-uae {
  width: 100%;
  height: 100%;
  min-height: 420px;  /* make it visibly taller */
  /* no max-height limit here */
}

.info-panel {
  flex: 2;
  border-radius: 12px;
  border: 1px solid #e0e0e0;
  background: #fafafa;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

/* Text in tabs 25% bigger vs previous */
.panel-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.2rem;
}

.panel-subtitle {
  font-size: 1.05rem;
  color: #666666;
  margin-bottom: 0.7rem;
}

.municipality-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  margin-bottom: 0.75rem;
}

.municipality-button {
  border-radius: 999px;
  border: 1px solid #cccccc;
  background: #ffffff;
  padding: 0.35rem 0.9rem;
  font-size: 1.125rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
}

.municipality-button.selected {
  border-color: #c62828;
  background: #ffebee;
  box-shadow: 0 0 0 1px rgba(198, 40, 40, 0.25);
}

.text-block {
  padding: 0.8rem;
  border-radius: 8px;
  background: #ffffff;
  border: 1px solid #dedede;
  font-size: 1rem;
  display: flex;
  align-items: flex-start;
}

.text-block-inner {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
}

.forecast-row {
  display: grid;
  grid-template-columns: 140px 1fr 150px;   /* Label | Value | Danger */
  align-items: center;
  row-gap: 0.5rem;                        /* vertical spacing */
  margin-bottom: 0.8rem;                   /* space between +6h and +12h blocks */
}

.label {
  font-weight: 600;
  margin-right: 0.3rem;
}

.text-block .value,
.text-block .danger-tag {
  font-weight: normal !important;
}

.forecast-title {
  font-weight: 600;
  margin-bottom: 0.8rem;
}

/* Forecast header: title on left, datetime on right */
.forecast-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 0.6rem;
}

.forecast-datetime {
  margin-left: 1rem;
  font-size: 1rem;
  color: #222222;
  white-space: nowrap;
}

.danger-tag {
  font-weight: 700;
  text-align: left;
  white-space: nowrap;
  margin-left: 1rem;
}

.danger-4 {
  color: #fb8c00; /* orange */
}

.danger-5 {
  color: #d32f2f; /* red */
}

.spacer {
  height: 0.5rem;
}

/* Footer */
.footer {
  flex-shrink: 0;
  background: #f0f0f0;
  margin-top: auto;
  padding: 0.6rem 1.25rem;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 1rem;
}

.footer-icon {
  font-size: 1rem;
}

.footer a {
  color: #0a66c2;
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

.linkedin-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  background: #0a66c2;
  color: #ffffff;
  font-size: 0.8rem;
  font-weight: 700;
  text-decoration: none;
}

@media (max-width: 900px) {
  .layout {
    flex-direction: column;
    height: auto;
    max-height: none;
  }

  .map-container {
    height: 320px;
  }

  .info-panel {
    min-height: 220px;
  }

  .footer {
    flex-wrap: wrap;
  }
}

/* === Gantt diagram === */
#gantt-container {
  position: relative;
  border: 1px solid #d0d0d0;
  border-radius: 6px;
  padding: 1.5rem 1rem 1rem;
  margin-top: 1rem;
  background: #fafafa;
  font-size: 0.9rem;
}

/* One row per task */
.gantt-row {
  position: relative;
  margin-bottom: 1rem;
  padding-left: 8rem; /* space for the label on the left */
}

/* Task label on the left */
.gantt-task-label {
  position: absolute;
  left: 0;
  top: 0.1rem;
  width: 7rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* The bar itself */
.gantt-bar {
  position: relative;
  height: 1.2rem;
  border-radius: 4px;
  background: #0a66c2;
  opacity: 0.85;
}

/* Tooltip on hover */
.gantt-bar::after {
  content: attr(data-dates);
  position: absolute;
  left: 50%;
  top: -1.5rem;
  transform: translateX(-50%);
  padding: 0.15rem 0.4rem;
  background: #333;
  color: #fff;
  font-size: 0.7rem;
  border-radius: 3px;
  opacity: 0;
  pointer-events: none;
  white-space: nowrap;
  transition: opacity 0.2s;
}

.gantt-bar:hover::after {
  opacity: 1;
}

/* optional: subtle horizontal separator lines */
.gantt-row:not(:last-child)::before {
  content: "";
  position: absolute;
  left: 8rem;
  right: 0;
  bottom: -0.4rem;
  height: 1px;
  background: #e0e0e0;
}
#gantt-axis {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  color: #444;
  margin-bottom: 0.4rem;
  padding: 0 0.5rem;
}

.gantt-axis-label {
  text-align: center;
  transform: translateX(-50%);
  white-space: nowrap;
}
</style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="title">Early warning and Emergency planner</div>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-target="tab-ch">Switzerland</button>
      <button class="tab-button" data-target="tab-uae">UAE</button>
      <button class="tab-button" data-target="tab-3">Project Timeline</button>
    </div>

    <!-- Switzerland tab -->
    <section id="tab-ch" class="tab-content active">
      <div class="layout">
        <div class="map-container">
          <div id="map-ch"></div>
        </div>
        <aside class="info-panel">
          <div>
            <div class="panel-title">Switzerland – Municipalities</div>
          </div>

          <div class="municipality-buttons">
            <button class="municipality-button" data-country="ch" data-id="zurich">Zürich</button>
            <button class="municipality-button" data-country="ch" data-id="geneva">Genève</button>
          </div>

          <!-- Municipality info -->
          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-row">
                <span class="label">Municipality:</span>
                <span class="value" id="ch-name">–</span>
              </div>
              <div class="forecast-row">
                <span class="label">Square area:</span>
                <span class="value" id="ch-area">–</span>
                <span class="value">km²</span>
              </div>
              <div class="forecast-row">
                <span class="label">Population:</span>
                <span class="value" id="ch-population">–</span>
              </div>
              <div class="forecast-row">
                <span class="label">Schools:</span>
                <span class="value" id="ch-schools">–</span>
              </div>
            </div>
          </div>

          <!-- Forecast block -->
          <div class="spacer"></div>

          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-header">
                <div class="forecast-title">Forecast</div>
                <div class="forecast-datetime" id="forecast-datetime-ch"></div>
              </div>
              <div class="forecast-row">
                <span class="label">+6h:</span>
                <span class="value">100 mm cumulative rainfall</span>
                <span class="danger-tag danger-4">level 4 danger</span>
              </div>
              <div class="forecast-row">
                <span class="label">+12h:</span>
                <span class="value">250 mm cumulative rainfall</span>
                <span class="danger-tag danger-5">level 5 danger</span>
              </div>
              <div class="forecast-row">
                <span class="label">Historical daily record:</span>
                <span class="value">145 mm (1974)</span>
              </div>
              <div class="forecast-row">
                <span class="label">24h Tmin:</span>
                <span class="value">5 °C</span>
              </div>
            </div>
          </div>

          <!-- Anomaly block -->
          <div class="spacer"></div>

          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-title">Hydro-meteorological anomalies last week:</div>
              <div class="forecast-row">
                <span class="label">Rainfall:</span>
                <span class="value">+50 mm</span>
              </div>
              <div class="forecast-row">
                <span class="label">River gauge:</span>
                <span class="value">0.68 meters (flood critical threshold 0.75 meters)</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>
    <!-- UAE tab -->
    <section id="tab-uae" class="tab-content">
      <div class="layout">
        <div class="map-container">
          <div id="map-uae"></div>
        </div>
        <aside class="info-panel">
          <div>
            <div class="panel-title">UAE – Municipalities</div>
          </div>

          <div class="municipality-buttons">
            <button class="municipality-button" data-country="uae" data-id="dubai">Dubai</button>
            <button class="municipality-button" data-country="uae" data-id="abudhabi">Abu Dhabi</button>
          </div>

          <!-- Municipality info -->
          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-row">
                <span class="label">Municipality:</span>
                <span class="value" id="uae-name">–</span>
              </div>
              <div class="forecast-row">
                <span class="label">Square area:</span>
                <span class="value" id="uae-area">–</span>
                <span class="value">km²</span>
              </div>
              <div class="forecast-row">
                <span class="label">Population:</span>
                <span class="value" id="uae-population">–</span>
              </div>
              <div class="forecast-row">
                <span class="label">Schools:</span>
                <span class="value" id="uae-schools">–</span>
              </div>
            </div>
          </div>

          <!-- Forecast block -->
          <div class="spacer"></div>

          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-header">
                <div class="forecast-title">Forecast</div>
                <div class="forecast-datetime" id="forecast-datetime-uae"></div>
              </div>
              <div class="forecast-row">
                <span class="label">+6h:</span>
                <span class="value">148 mm cumulative rainfall</span>
                <span class="danger-tag danger-4">level 4 danger</span>
              </div>
              <div class="forecast-row">
                <span class="label">+12h:</span>
                <span class="value">250 mm cumulative rainfall</span>
                <span class="danger-tag danger-5">level 5 danger</span>
              </div>
              <div class="forecast-row">
                <span class="label">Historical record:</span>
                <span class="value">180 mm (1992)</span>
              </div>
              <div class="forecast-row">
                <span class="label">24h Tmin:</span>
                <span class="value">18 °C</span>
              </div>
            </div>
          </div>

          <!-- Anomaly block -->
          <div class="spacer"></div>

          <div class="text-block">
            <div class="text-block-inner">
              <div class="forecast-title">Hydro-meteorological anomalies last week:</div>
              <div class="forecast-row">
                <span class="label">Rainfall:</span>
                <span class="value">+23 mm</span>
              </div>
              <div class="forecast-row">
                <span class="label">River gauge:</span>
                <span class="value">0.17 meters (flood critical threshold 0.34 meters)</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <section id="tab-3" class="tab-content">
      <h2>Project timeline</h2>
      <div id="gantt-axis"></div>
      <div id="gantt-container"></div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <span>Project director:</span>
      <span class="footer-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0a66c2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      </span>
      <a href="mailto:islam.ragab@sihub.ch">islam.ragab@sihub.ch</a>
      <a
        class="linkedin-badge"
        href="https://www.linkedin.com/in/islam-ragab-/"
        target="_blank"
        rel="noopener"
        aria-label="LinkedIn profile"
        >
        <img src="icons/ln.svg" alt="LinkedIn" style="width:30px;height:30px;" />
      </a>
      &nbsp;<span>|</span>&nbsp;
       <span>Website designer: Elena Maksimovich</span>
      <a
        class="linkedin-badge"
        href="https://www.linkedin.com/in/elena-maksimovich/"
        target="_blank"
        rel="noopener"
        aria-label="LinkedIn profile"
        >
        <img src="icons/ln.svg" alt="LinkedIn" style="width:30px;height:30px;" />
      </a>
    </footer>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
// =======================
// Tabs + Gantt handling
// =======================

const tabButtons = document.querySelectorAll(".tab-button");
const tabContents = document.querySelectorAll(".tab-content");

tabButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    tabButtons.forEach((b) => b.classList.remove("active"));
    tabContents.forEach((c) => c.classList.remove("active"));

    btn.classList.add("active");
    const targetId = btn.getAttribute("data-target");
    document.getElementById(targetId).classList.add("active");

    // If we switched to the Gantt tab, render it
    if (targetId === "tab-3") {
      ensureGanttRendered();
    }

    // Fix map display after tab switch
    setTimeout(() => {
      mapCH.invalidateSize();
      mapUAE.invalidateSize();
    }, 80);
  });
});

// =======================
// Municipality data (info panel values)
// =======================

const municipalityData = {
  ch: {
    zurich: {
      name: "Zürich",
      area: "87.9",
      population: "448,664",
      schools: "1,170",
    },
    geneva: {
      name: "Genève",
      area: "16.0",
      population: "203,856",
      schools: "599",
    },
  },
  uae: {
    dubai: {
      name: "Dubai",
      area: "4,771",
      population: "3,655,000",
      schools: "220",
    },
    abudhabi: {
      name: "Abu Dhabi",
      area: "972",
      population: "1,567,000",
      schools: "369",
    },
  },
};

function updateMunicipalityInfo(country, id) {
  const data = municipalityData[country] && municipalityData[country][id];
  if (!data) return;

  if (country === "ch") {
    document.getElementById("ch-name").textContent = data.name;
    document.getElementById("ch-area").textContent = data.area;
    document.getElementById("ch-population").textContent = data.population;
    document.getElementById("ch-schools").textContent = data.schools;

    const buttons = document.querySelectorAll(
      '.municipality-button[data-country="ch"]'
    );
    buttons.forEach((b) =>
      b.classList.toggle("selected", b.getAttribute("data-id") === id)
    );
  } else if (country === "uae") {
    document.getElementById("uae-name").textContent = data.name;
    document.getElementById("uae-area").textContent = data.area;
    document.getElementById("uae-population").textContent = data.population;
    document.getElementById("uae-schools").textContent = data.schools;

    const buttons = document.querySelectorAll(
      '.municipality-button[data-country="uae"]'
    );
    buttons.forEach((b) =>
      b.classList.toggle("selected", b.getAttribute("data-id") === id)
    );
  }
}

// =======================
// Time / forecast label
// =======================

function formatForecastDateTime() {
  const now = new Date();

  const hours = String(now.getHours()).padStart(2, "0");
  const minutes = String(now.getMinutes()).padStart(2, "0");

  const day = String(now.getDate()).padStart(2, "0");

  const monthNames = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];
  const month = monthNames[now.getMonth()];
  const year = now.getFullYear();

  return `Current local time ${hours}:${minutes}, ${day} ${month} ${year}`;
}

function updateForecastDateTimes() {
  const formatted = formatForecastDateTime();
  const elCH = document.getElementById("forecast-datetime-ch");
  const elUAE = document.getElementById("forecast-datetime-uae");
  if (elCH) elCH.textContent = formatted;
  if (elUAE) elUAE.textContent = formatted;
}

// =======================
// Base layers: light gray canvas and satellite imagery
// =======================

const lightGray = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: "Tiles © Esri — Esri, DeLorme, NAVTEQ",
    maxZoom: 18,
  }
);

const worldImagery = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    attribution:
      "Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community",
    maxZoom: 18,
  }
);

// Switzerland map
const mapCH = L.map("map-ch", {
  center: [46.8, 8.2],
  zoom: 8,
  minZoom: 8,
  layers: [lightGray],
});

const baseMapsCH = {
  "Light gray": lightGray,
  Satellite: worldImagery,
};
L.control.layers(baseMapsCH, null, { position: "topright" }).addTo(mapCH);

// UAE base layers
const lightGray2 = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: "Tiles © Esri — Esri, DeLorme, NAVTEQ",
    maxZoom: 18,
  }
);

const worldImagery2 = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    attribution:
      "Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community",
    maxZoom: 18,
  }
);

// Bounds to keep the UAE centered and avoid global view
const uaeBounds = L.latLngBounds(
  [26, 56], // NW
  [24, 51] // SE
);

const mapUAE = L.map("map-uae", {
  center: [30.5, 54],
  zoom: 8.5,
  layers: [lightGray2],
  maxBounds: uaeBounds.pad(0.05),
  maxBoundsViscosity: 1.0,
  minZoom: 7,
});

const baseMapsUAE = {
  "Light gray": lightGray2,
  Satellite: worldImagery2,
};
L.control.layers(baseMapsUAE, null, { position: "topright" }).addTo(mapUAE);

// Fit to UAE only (no global view)
mapUAE.fitBounds(uaeBounds);

// =======================
// Switzerland + UAE polygons
// =======================

// Zürich feature (hard-coded)
const zurichFeature = {
  type: "Feature",
  properties: { id: "zurich", name: "Zürich" },
  geometry: {
    type: "Polygon",
    coordinates: [
      [
        [8.46, 47.33],
        [8.55, 47.32],
        [8.63, 47.36],
        [8.6, 47.44],
        [8.5, 47.46],
        [8.46, 47.4],
        [8.46, 47.33],
      ],
    ],
  },
};

// Start Switzerland collection with Zürich only; Geneva will be added from geneva.json
const switzerlandMunicipalities = {
  type: "FeatureCollection",
  features: [zurichFeature],
};

const swissLayers = {};
let swissGeo;

const uaeMunicipalities = {
  type: "FeatureCollection",
  features: [
    {
      type: "Feature",
      properties: { id: "dubai", name: "Dubai" },
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [55.18, 25.17],
            [55.3, 25.15],
            [55.37, 25.22],
            [55.33, 25.29],
            [55.22, 25.31],
            [55.17, 25.24],
            [55.18, 25.17],
          ],
        ],
      },
    },
    {
      type: "Feature",
      properties: { id: "abudhabi", name: "Abu Dhabi" },
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [54.25, 24.35],
            [54.45, 24.32],
            [54.55, 24.42],
            [54.5, 24.57],
            [54.32, 24.62],
            [54.23, 24.48],
            [54.25, 24.35],
          ],
        ],
      },
    },
  ],
};

const uaeLayers = {};

// =======================
// Styles + interaction
// =======================

function municipalityStyle() {
  return {
    color: "#b71c1c",
    weight: 2,
    fillColor: "#ef5350",
    fillOpacity: 0.2, // lighter fill for base
  };
}

function municipalityHighlightStyle() {
  return {
    weight: 3,
    fillOpacity: 0.55, // stronger semi-transparent red when highlighted
  };
}

function resetSwissStyles() {
  Object.values(swissLayers).forEach((layer) =>
    layer.setStyle(municipalityStyle())
  );
}

function resetUaeStyles() {
  Object.values(uaeLayers).forEach((layer) =>
    layer.setStyle(municipalityStyle())
  );
}

function onSwissFeature(feature, layer) {
  const id = feature.properties.id;
  swissLayers[id] = layer;
  layer.setStyle(municipalityStyle());
  layer.on("click", () => {
    resetSwissStyles();
    layer.setStyle({
      ...municipalityStyle(),
      ...municipalityHighlightStyle(),
    });
    updateMunicipalityInfo("ch", id);
  });
}

function onUaeFeature(feature, layer) {
  const id = feature.properties.id;
  uaeLayers[id] = layer;
  layer.setStyle(municipalityStyle());
  layer.on("click", () => {
    resetUaeStyles();
    layer.setStyle({
      ...municipalityStyle(),
      ...municipalityHighlightStyle(),
    });
    updateMunicipalityInfo("uae", id);
  });
}

// =======================
// Load Geneva from external geneva.json
// =======================

fetch("geneva.json")
  .then((res) => res.json())
  .then((genevaFeature) => {
    // If geneva.json is a FeatureCollection, take the first feature
    if (genevaFeature.type === "FeatureCollection") {
      genevaFeature = genevaFeature.features[0];
    }

    genevaFeature.properties = genevaFeature.properties || {};
    genevaFeature.properties.id = "geneva";
    genevaFeature.properties.name = "Genève";

    // Add to FeatureCollection
    switzerlandMunicipalities.features.push(genevaFeature);

    // Create the Leaflet GeoJSON layer now that we have both municipalities
    swissGeo = L.geoJSON(switzerlandMunicipalities, {
      onEachFeature: onSwissFeature,
    }).addTo(mapCH);

    mapCH.fitBounds(swissGeo.getBounds());
  })
  .catch((err) => {
    console.error("Failed to load Geneva GeoJSON:", err);
  });

// =======================
// UAE polygons layer
// =======================

const uaeGeo = L.geoJSON(uaeMunicipalities, {
  onEachFeature: onUaeFeature,
}).addTo(mapUAE);

// =======================
// Buttons -> map + info sync
// =======================

function setupMunicipalityButtons(country, layers, map) {
  const buttons = document.querySelectorAll(
    '.municipality-button[data-country="' + country + '"]'
  );

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");

      // Update stats / info
      updateMunicipalityInfo(country, id);

      // Highlight polygon and zoom
      const layer = layers[id];
      if (layer) {
        if (country === "ch") resetSwissStyles();
        if (country === "uae") resetUaeStyles();
        layer.setStyle({
          ...municipalityStyle(),
          ...municipalityHighlightStyle(),
        });
        map.fitBounds(layer.getBounds(), { maxZoom: 11 });
      }
    });
  });
}

setupMunicipalityButtons("ch", swissLayers, mapCH);
setupMunicipalityButtons("uae", uaeLayers, mapUAE);

// =======================
// Init default selections + time labels
// =======================

updateMunicipalityInfo("ch", "zurich");
updateMunicipalityInfo("uae", "dubai");

updateForecastDateTimes();
setInterval(updateForecastDateTimes, 60 * 1000);

// =======================
// Gantt definition
// =======================

const ganttTasks = [
  {
    name: "Historical weather data collection",
    start: "2026-01-01",
    end: "2026-01-15",
  },
  {
    name: "Radar & Satellite weather data collection",
    start: "2026-01-15",
    end: "2026-02-01",
  },
  {
    name: "Predictive model setup",
    start: "2026-02-10",
    end: "2026-03-15",
  },
  {
    name: "Predictive model calibration",
    start: "2026-03-10",
    end: "2026-04-05",
  },
  {
    name: "Test phase",
    start: "2026-04-01",
    end: "2026-07-01",
  },
  {
    name: "Deployment",
    start: "2026-07-01",
    end: "2026-09-01",
  },
];
function renderGantt(tasks) {
  const container = document.getElementById("gantt-container");
  const axis = document.getElementById("gantt-axis");
  if (!container || !tasks || tasks.length === 0) return;

  const parseDate = (str) => new Date(str + "T00:00:00");

  const dates = tasks.flatMap((t) => [parseDate(t.start), parseDate(t.end)]);
  const minDate = new Date(Math.min.apply(null, dates));
  const maxDate = new Date(Math.max.apply(null, dates));

  const oneDay = 24 * 60 * 60 * 1000;
  const totalDays = Math.max(1, Math.round((maxDate - minDate) / oneDay));

  container.innerHTML = "";
  axis.innerHTML = "";

  // ----------- X AXIS (Time scale) --------------
  const numTicks = 6; // adjust the number of labels you want
  for (let i = 0; i <= numTicks; i++) {
    const ratio = i / numTicks;
    const date = new Date(minDate.getTime() + ratio * (maxDate - minDate));

    const label = document.createElement("div");
    label.className = "gantt-axis-label";
    label.style.position = "absolute";
    label.style.left = ratio * 100 + "%";

    // format date as YYYY-MM-DD
    label.textContent =
      date.getFullYear() +
      "-" +
      String(date.getMonth() + 1).padStart(2, "0") +
      "-" +
      String(date.getDate()).padStart(2, "0");

    axis.appendChild(label);
  }

  axis.style.position = "relative";
  axis.style.height = "1.2rem";

  // ----------- TASK BARS --------------
  tasks.forEach((task) => {
    const start = parseDate(task.start);
    const end = parseDate(task.end);

    const offsetDays = Math.max(0, Math.round((start - minDate) / oneDay));
    const durationDays = Math.max(1, Math.round((end - start) / oneDay));

    const offsetPct = (offsetDays / totalDays) * 100;
    const widthPct = (durationDays / totalDays) * 100;

    const row = document.createElement("div");
    row.className = "gantt-row";

    const label = document.createElement("div");
    label.className = "gantt-task-label";
    label.textContent = task.name;

    const bar = document.createElement("div");
    bar.className = "gantt-bar";
    bar.style.marginLeft = offsetPct + "%";
    bar.style.width = widthPct + "%";
    bar.setAttribute("data-dates", `${task.start} → ${task.end}`);

    row.appendChild(label);
    row.appendChild(bar);
    container.appendChild(row);
  });
}
let ganttRendered = false;

function ensureGanttRendered() {
  if (ganttRendered) return;
  renderGantt(ganttTasks);
  ganttRendered = true;
}

// If Gantt tab is initially active on page load
if (document.getElementById("tab-3")?.classList.contains("active")) {
  ensureGanttRendered();
}

</script>
</body>
</html>
